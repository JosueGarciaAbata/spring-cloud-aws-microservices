# ==== Etapa 1: Build ====
FROM maven:3.9-eclipse-temurin-21 AS builder

# Directorio de trabajo dentro del contenedor
WORKDIR /workspace

# Copiamos pom.xml para cache de dependencias
COPY ./config-server/pom.xml .

# Descarga solo dependencias (cache layer)
RUN mvn dependency:go-offline -B

# Copiamos el código fuente
COPY ./config-server/src ./src

# Construye el artifact JAR (sin tests para acelerar)
RUN mvn clean package -DskipTests

# ==== Etapa 2: Runtime ====
FROM eclipse-temurin:21-jre-alpine

# Crear un usuario no root por seguridad
RUN addgroup -S springg && adduser -S springu -G springg
USER springu

WORKDIR /app

# Copiamos el JAR desde el builder
COPY --from=builder /workspace/target/*.jar app.jar

# Especifica el puerto en el que corre tu aplicación
EXPOSE 8888

# JVM optimizada para contenerizadores
ENTRYPOINT ["java", "-XX:+UseContainerSupport", "-XX:MaxRAMPercentage=75.0", "-XX:+UseG1GC", "-jar", "app.jar"]
